---
title: "Resumen CNAA IXR"
author: "Marion Díaz"
date: "2024-10-14"
output: html_document
---

PACKAGES
```{r}
library(tidyverse)
library(lubridate)
library(ggrepel)
library(Cairo)
library(gt)
library(webshot2)
library(dplyr)
library(tidyr)
```

LEER Y LIMPIAR DATOS
```{r}
data <- read.csv("datos cnaa oct 2024.csv")

#incluye .sp
especies <- read.csv("especies censables cnaa.csv")
especies <- especies %>% 
  mutate(Scientific.Name = scientific_name)

#remover subespecies y solo dejar especies censables 
especies_limpio <- read.csv("especies censables cnaa limpio.csv")
especies_limpio <- especies_limpio %>% 
  mutate(Scientific.Name = scientific_name)

#limpiar y transformar datos
data <- data %>% 
  mutate(Date = as.Date(Date), Count = as.numeric(Count), Common.Name = as.factor(Common.Name), Scientific.Name = as.factor(Scientific.Name), Región = as.factor(State.Province), Location = as.factor(Location)) %>% 
  inner_join(especies_limpio, by = 'Scientific.Name') %>% 
  droplevels()
  
#ordenar regiones
levels(data$Región)<- c('Aysén', 'Antofagasta', 'Arica y Parinacota','Araucanía', 'Atacama', 'Bío-Bío', 'Coquimbo', "O'Higgins",'Los Lagos', 'Los Ríos', 'Magallanes', 'Maule', 'Ñuble', 'Metropolitana', 'Tarapacá', 'Valparaíso')
data$Región <- factor(data$Región, levels = c('Arica y Parinacota','Tarapacá', 'Antofagasta', 'Atacama','Coquimbo','Valparaíso', 'Metropolitana',"O'Higgins",'Maule', 'Ñuble','Bío-Bío','Araucanía', 'Los Ríos','Los Lagos', 'Aysén','Magallanes'))

```


REGIONAL
```{r}

IX <- filter(data, Región == "Araucanía")

#separar datos para verano e invierno 
data_verano <- IX%>% 
  filter(Date >= as.Date(paste(year(Date), 01, 15, sep = "-")),
           Date <= as.Date(paste(year(Date), 02, 28, sep = "-")))

data_invierno <- IX%>% 
  filter(Date >= as.Date(paste(year(Date), 06, 15, sep = "-")),
           Date <= as.Date(paste(year(Date), 08, 15, sep = "-")))

#Riqueza
sp_verano <- data_verano %>%
  group_by(year(Date)) %>% 
  summarise(richness = n_distinct(Common.Name)) %>%
  rename(date='year(Date)')%>%
  mutate(Censo = "Verano")

sp_invierno <- data_invierno %>%
  group_by(year(Date)) %>% 
  summarise(richness = n_distinct(Common.Name)) %>% 
  rename(date='year(Date)')%>%
  mutate(Censo = "Invierno")

sp_all <- rbind(sp_verano,sp_invierno)

sp_plot <- ggplot(sp_all, aes(x = date, y = richness, fill=Censo, col=Censo)) +
  geom_line(linewidth = 1) +
  labs(x = "", y = "N especies") +
  scale_x_continuous(n.breaks = 9)+
  scale_color_manual(values=c('Verano' = 'darkorange', 'Invierno' = 'lightblue'))+
  theme_classic()+
  theme(legend.position = 'none')+
  ylim(0,50)

#Abundancia relativa
ab_verano <- data_verano %>%
  group_by(year(Date)) %>% 
  summarise(Abundancia = sum(Count, na.rm=T)) %>% 
  rename(date='year(Date)')%>%
  mutate(Censo = "Verano")

ab_invierno <- data_invierno %>%
  group_by(year(Date)) %>% 
  summarise(Abundancia = sum(Count, na.rm=T)) %>% 
  rename(date='year(Date)')%>%
  mutate(Censo = "Invierno")

ab_all <- rbind(ab_verano,ab_invierno)

ab_plot <- ggplot(ab_all, aes(x = date, y = Abundancia, fill=Censo, col=Censo)) +
  geom_line(size=1) +
  scale_x_continuous(n.breaks = 9)+
  labs(x = "", y = 'N individuos') +
  scale_color_manual(values=c('Verano' = 'darkorange', 'Invierno' = 'lightblue'))+
  theme_classic()+
  theme(legend.position = 'none')+
  ylim(0,10000)

#Censos por temporada por año
sitios_verano <- data_verano %>% 
  group_by(year(Date)) %>% 
  summarise(N = n_distinct(Location)) %>% 
  rename(date='year(Date)')%>%
  mutate(Censo = "Verano")

sitios_invierno <- data_invierno %>% 
  group_by(year(Date)) %>% 
  summarise(N = n_distinct(Location)) %>% 
  rename(date='year(Date)')%>%
  mutate(Censo = "Invierno")

sitios_all <- rbind(sitios_verano,sitios_invierno)

sitios_plot <- ggplot(sitios_all, aes(x = date, y = N, fill=Censo, col=Censo)) +
  geom_line(size=1) +
  labs(x = "", y = 'N sitios') +
  scale_color_manual(values=c('Verano' = 'darkorange', 'Invierno' = 'lightblue'))+
  scale_x_continuous(n.breaks = 9)+
  theme_classic()+
  theme(legend.position = c(0.2, 0.8))+
  geom_text_repel(aes(label=N),vjust= -2,  size=3.5,show.legend = F)+
  ylim(0,25)

ggsave("Riqueza IXR CNAA Oct 2024.png", sp_plot, width = 4.5, height = 3.5, dpi = 300, type = "cairo")
ggsave("Abundancia IXR CNAA Oct 2024.png", ab_plot, width = 4.5, height = 3.5, dpi = 300, type = "cairo")
ggsave("Sitios IXR CNAA Oct 2024.png", sitios_plot, width = 4.5, height = 3.5, dpi = 300, type = "cairo")
```

```{r}
#Registros de especies
SPs_region_inv <- data_invierno %>%
  mutate(Date = as.Date(Date)) %>%
  group_by(Common.Name, year(Date)) %>%
  summarise(Total_Count = sum(Count, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = `year(Date)`, values_from = Total_Count, values_fill = 0) %>%
  rename(`Especie` = Common.Name) %>%
  mutate(across(`2009`:`2024`, ~replace_na(.x, 0))) %>%
  select(`Especie`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2022`, `2023`, `2024`) %>%
  arrange(`Especie`) 

SPs_region_inv <- SPs_region_inv %>%
  gt() %>%
  data_color(
    columns = c(`2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2022`, `2023`, `2024`),
    method = "numeric",
    palette = "Blues",
    domain = c(0, max(range(SPs_region_inv %>% select(-Especie), na.rm = TRUE)))
  )

SPs_region_inv

SPs_region_ver <- data_verano %>%
  mutate(Date = as.Date(Date)) %>%  
  group_by(Common.Name, year(Date)) %>% 
  summarise(Total_Count = sum(Count, na.rm = TRUE), .groups = 'drop') %>%  
  pivot_wider(names_from = `year(Date)`, values_from = Total_Count, values_fill = 0) %>%  
  rename(`Especie` = Common.Name) %>%  
  mutate(across(`2010`:`2024`, ~replace_na(.x, 0))) %>%  
  select(`Especie`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2018`, `2019`, `2023`, `2024`) %>%  
  arrange(`Especie`) 

SPs_region_ver <- SPs_region_ver %>%
  gt() %>% 
  data_color(
    columns = c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2018`, `2019`, `2023`, `2024`),
    method = "numeric",
    palette = "Oranges",
    domain = c(0, max(range(SPs_region_ver %>% select(-Especie), na.rm = TRUE)))
  )

SPs_region_ver

gtsave(SPs_region_ver, file = "SPs IXR CNAA oct 2024 ver.png")
gtsave(SPs_region_inv, file = "SPs IXR CNAA oct 2024 inv.png")
```


```{r}
#Sitios censados en la región

replicas.ver <- data_verano %>%
  mutate(Date = as.Date(Date)) %>%  
  group_by(Location, year(Date)) %>%  
  summarise(Visitado = n_distinct(Location), .groups = 'drop') %>%  
  mutate(Visitado = ifelse(Visitado > 0, "*", "")) 

Sitios_region_ver <- replicas.ver %>%
  pivot_wider(names_from = `year(Date)`, values_from = Visitado, values_fill = "") %>%  
  rename(`Sitio` = Location) %>%  
  select(`Sitio`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2018`, `2019`, `2023`, `2024`) %>%
  mutate(Total = rowSums(across(`2010`:`2024`, ~ . != ""))) %>%
  arrange(`Sitio`) %>%  
  gt() %>% 
  data_color(
    columns = Total,  
    method = "numeric", 
    palette = "Oranges"  
  )


replicas.inv <- data_invierno %>%
  mutate(Date = as.Date(Date)) %>%  
  group_by(Location, year(Date)) %>%  
  summarise(Visitado = n_distinct(Location), .groups = 'drop') %>%  
  mutate(Visitado = ifelse(Visitado > 0, "*", "")) 

Sitios_region_inv <- replicas.inv %>%
  pivot_wider(names_from = `year(Date)`, values_from = Visitado, values_fill = "") %>%  
  rename(`Sitio` = Location) %>%  
  select(`Sitio`, `2009`, `2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2018`, `2022`, `2023`, `2024`) %>%
  mutate(Total = rowSums(across(`2009`:`2024`, ~ . != ""))) %>%
  arrange(`Sitio`) %>%  
  gt() %>% 
  data_color(
    columns = Total,  
    method = "numeric", 
    palette = "Blues"  
  )


gtsave(Sitios_region_ver, file = "Sitios IXR CNAA oct 2024 ver.png")
gtsave(Sitios_region_inv, file = "Sitios IXR CNAA oct 2024 inv.png")
```



